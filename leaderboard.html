<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select Start Leaderboard</title>
  <style>
    /* Your full existing CSS remains unchanged... */
    /* To save space here, I'm omitting it, but your original CSS from <style> to </style> goes here. */
  </style>
</head>
<body>
  <div id="ra-leaderboard" class="leaderboard-container"></div>

  <script>
    const CONFIG = {
      apiUrl: 'https://select-start-api-production.up.railway.app/api',
      apiKey: '123456789',
      refreshInterval: 300000,
      defaultTab: 'monthly'
    };

    class Leaderboard {
      constructor(containerId, config) {
        this.container = document.getElementById(containerId);
        this.config = config;
        this.currentTab = this.config.defaultTab;
        this.data = {
          monthly: null,
          yearly: null
        };
        this.init();
      }

      async init() {
        this.renderLoading();
        try {
          await this.fetchData(this.currentTab);
          this.renderLeaderboard();
          this.startAutoRefresh();
        } catch (error) {
          this.renderError(error);
        }
      }

      renderLoading() {
        this.container.innerHTML = `
          <div class="leaderboard-header">
            <h2 class="leaderboard-title">Select Start Leaderboard</h2>
          </div>
          <div class="loading">
            <div class="loading-spinner"></div>
            Loading leaderboard data...
          </div>
        `;
      }

      renderError(error) {
        console.error('Leaderboard error:', error);
        this.container.innerHTML = `
          <div class="leaderboard-header">
            <h2 class="leaderboard-title">Select Start Leaderboard</h2>
          </div>
          <div class="error">
            <p>Failed to load leaderboard data.</p>
            <p>${error.message || 'Please try again later.'}</p>
          </div>
        `;
      }

      formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      getRankIcon(rank) {
        if (rank === 1) return 'üèÖ';
        if (rank === 2) return 'ü•à';
        if (rank === 3) return 'ü•â';
        if (rank <= 3) return '‚≠ê';
        return 'üèÅ';
      }

      async fetchData(type = 'monthly') {
        if (type !== 'monthly' && type !== 'yearly') {
          throw new Error('Invalid leaderboard type');
        }

        const response = await fetch(`${this.config.apiUrl}/leaderboard/${type}`, {
          method: 'GET',
          headers: {
            'x-api-key': this.config.apiKey
          }
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        this.data[type] = data;
        return data;
      }

      renderLeaderboard() {
        const data = this.data[this.currentTab];
        if (!data) {
          this.renderError(new Error('No data available'));
          return;
        }

        let headerContent, challengeInfo = '';

        if (this.currentTab === 'monthly') {
          headerContent = `${data.challenge?.monthYear || 'Current Month'} Challenge Leaderboard`;

          if (data.challenge?.monthlyGame) {
            challengeInfo = `
              <div class="challenge-info">
                Game: <span class="challenge-highlight">Ape Escape</span>
                ‚Ä¢ Total Achievements: <span class="challenge-highlight">68</span>
              </div>
            `;
          }
        } else {
          headerContent = `${data.year || new Date().getFullYear()} Yearly Leaderboard`;
        }

        let headerHTML = `
          <div class="leaderboard-header">
            <h2 class="leaderboard-title">${headerContent}</h2>
            ${challengeInfo}
          </div>
        `;

        let tabsHTML = `
          <div class="leaderboard-tabs">
            <div class="tab ${this.currentTab === 'monthly' ? 'active' : ''}" data-tab="monthly">Monthly</div>
            <div class="tab ${this.currentTab === 'yearly' ? 'active' : ''}" data-tab="yearly">Yearly</div>
          </div>
        `;

        let tableHTML = this.currentTab === 'monthly'
          ? this.renderMonthlyTable(data.leaderboard)
          : this.renderYearlyTable(data.leaderboard);

        let lastUpdatedHTML = `
          <div class="last-updated">
            Updated: ${this.formatDate(data.lastUpdated)}
          </div>
        `;

        this.container.innerHTML = headerHTML + tabsHTML + tableHTML + lastUpdatedHTML;

        const tabs = this.container.querySelectorAll('.tab');
        tabs.forEach(tab => {
          tab.addEventListener('click', (event) => {
            const tabType = event.target.getAttribute('data-tab');
            this.switchTab(tabType);
          });
        });
      }

      renderMonthlyTable(leaderboard) {
        if (!leaderboard || !leaderboard.length) {
          return `
            <div class="error">
              <p>No leaderboard data available for this month.</p>
            </div>
          `;
        }

        const total = 68; // Hardcoded for now
        const filtered = leaderboard.filter(entry => Math.round(entry.totalPoints * 10) > 0);

        if (!filtered.length) {
          return `
            <div class="error">
              <p>No active players yet for this month's challenge.</p>
            </div>
          `;
        }

        let tableRows = '';
        filtered.forEach((entry, index) => {
          const rank = index + 1;
          const rankIcon = this.getRankIcon(rank);
          const completed = Math.round(entry.totalPoints * 10);
          const percentage = ((completed / total) * 100).toFixed(2);

          tableRows += `
            <tr>
              <td class="rank-cell">${rankIcon}</td>
              <td class="username-cell">${entry.username}</td>
              <td class="progress-cell">${completed}/${total} (${percentage}%)</td>
            </tr>
          `;
        });

        return `
          <div style="overflow-x: auto;">
            <table class="leaderboard-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Player</th>
                  <th>Progress</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
      }

      renderYearlyTable(leaderboard) {
        if (!leaderboard || !leaderboard.length) {
          return `
            <div class="error">
              <p>No leaderboard data available for this year.</p>
            </div>
          `;
        }

        let tableRows = '';
        leaderboard.forEach((entry, index) => {
          const rank = index + 1;
          const rankIcon = this.getRankIcon(rank);

          tableRows += `
            <tr>
              <td class="rank-cell">${rankIcon}</td>
              <td>${entry.username}</td>
              <td class="progress-cell">${entry.yearlyPoints} points</td>
            </tr>
          `;
        });

        return `
          <div style="overflow-x: auto;">
            <table class="leaderboard-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Player</th>
                  <th>Points</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
      }

      async switchTab(tabType) {
        if (tabType === this.currentTab) return;

        this.currentTab = tabType;
        this.renderLoading();

        try {
          if (!this.data[tabType]) {
            await this.fetchData(tabType);
          }
          this.renderLeaderboard();
        } catch (error) {
          this.renderError(error);
        }
      }

      startAutoRefresh() {
        setInterval(() => {
          if (!document.hidden) {
            this.fetchData(this.currentTab)
              .then(() => this.renderLeaderboard())
              .catch(error => console.error('Auto-refresh error:', error));
          }
        }, this.config.refreshInterval);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new Leaderboard('ra-leaderboard', CONFIG);
    });
  </script>
</body>
</html>
